// RingRank Report - Generated {{.GeneratedAt}}
#set document(title: "Ring Preferences Report", author: "RingRank")
#set page(
  paper: "us-letter",
  margin: (x: 0.4in, y: 0.4in),
  header: context {
    if counter(page).get().first() > 1 [
      #set text(size: 8pt, fill: gray)
      Ring Preferences Report
      #h(1fr)
      #counter(page).display()
    ]
  },
)
#set text(font: "Helvetica Neue", size: 9pt)

// Title Page
#align(center)[
  #v(1.5in)
  #text(size: 28pt, weight: "bold")[Ring Preferences]
  #v(0.2in)
  #text(size: 12pt, fill: gray)[Your personalized ring ranking report]
  #v(0.3in)
  #line(length: 2.5in, stroke: 0.5pt + gray)
  #v(0.2in)
  #text(size: 10pt)[
    Generated: {{.GeneratedAt}} \
    Total Comparisons: {{.TotalComparisons}} \
    Rings Evaluated: {{.TotalRings}}
  ]
  {{if .SingleCategory}}
  #v(0.15in)
  #text(size: 11pt, weight: "medium")[Category: {{.SingleCategoryLabel}}]
  {{end}}
  #v(0.5in)
  {{if .ShowTopOnly}}
  #text(size: 9pt, fill: gray)[Showing Top {{.TopCount}} per category]
  {{else}}
  #text(size: 9pt, fill: gray)[Complete rankings]
  {{end}}
]

#pagebreak()

// Helper function for score bars
#let score-bar(score) = {
  let normalized = calc.min(100, calc.max(0, (score - 600) / 8))
  box(
    width: 60pt,
    height: 6pt,
    fill: luma(230),
    radius: 2pt,
    box(
      width: normalized * 0.6pt,
      height: 6pt,
      fill: black,
      radius: 2pt,
    )
  )
}

// Helper for ranking entry - large image with clickable link
#let rank-entry(rank, image-path, filename, score, file-link) = {
  box(
    width: 100%,
    inset: 6pt,
    stroke: (bottom: 0.5pt + luma(220)),
    grid(
      columns: (30pt, 160pt, 1fr),
      align: (center + horizon, center + horizon, left + horizon),
      gutter: 10pt,
      // Rank
      text(size: 20pt, weight: "bold")[#rank],
      // Image (clickable to open file)
      stack(
        dir: ttb,
        spacing: 3pt,
        if image-path != "" {
          link(file-link)[#image(image-path, width: 150pt, height: 150pt, fit: "contain")]
        } else {
          box(width: 150pt, height: 150pt, fill: luma(240), radius: 4pt)
        },
        // Filename (small, below image)
        link(file-link)[#text(size: 6pt, fill: gray)[#filename]],
      ),
      // Score section
      stack(
        dir: ttb,
        spacing: 5pt,
        text(size: 18pt, weight: "bold")[#calc.round(score)],
        score-bar(score),
        text(size: 7pt, fill: gray)[Glicko-2 rating],
      ),
    )
  )
}

{{range .Categories}}
// Category: {{.Label}}
#heading(level: 1)[{{.Label}}]
#text(size: 9pt, fill: gray)[{{.Comparisons}} comparisons]
#v(0.1in)

{{if .Rings}}
{{range .Rings}}
#rank-entry({{.Rank}}, "{{.ImagePath}}", "{{.Filename}}", {{printf "%.1f" .Score}}, "file://{{.FileLink}}")
{{end}}
{{else}}
#align(center)[
  #v(0.3in)
  #text(fill: gray)[No comparisons yet in this category]
  #v(0.3in)
]
{{end}}

#pagebreak(weak: true)
{{end}}

{{if .ShowCrossCategorySummary}}
// Cross-Category Summary
#heading(level: 1)[Cross-Category Performance]
#v(0.1in)
#text(size: 8pt, fill: gray)[Rankings out of {{.TotalRings}} rings]
#v(0.1in)

#set text(size: 8pt)
#block(width: 100%)[
#table(
  columns: (1fr, 2fr, {{range .Categories}}1fr, {{end}}1fr),
  align: (center + horizon, center + horizon, {{range .Categories}}center + horizon, {{end}}center + horizon),
  stroke: 0.5pt + luma(200),
  inset: 6pt,
  fill: (x, y) => if y == 0 { luma(240) } else { none },
  [*Avg*], [*Ring*], {{range .Categories}}[*{{.Label}}*], {{end}}[*Score*],
  {{range .RingSummaries}}
  [{{.AvgRank}}],
  [#link("file://{{.FileLink}}")[#stack(dir: ttb, spacing: 3pt, image("{{.ImagePath}}", width: 90pt, height: 90pt, fit: "contain"), text(size: 5pt, fill: gray)[{{.Filename}}])]],
  {{range .CategoryRanks}}[{{.}}], {{end}}
  [{{.TotalScore}}],
  {{end}}
)
]
#set text(size: 9pt)

#pagebreak(weak: true)
{{end}}

// Summary Page
#heading(level: 1)[Summary]

#v(0.2in)
#text(size: 10pt)[
  This report was generated based on {{.TotalComparisons}} pairwise comparisons
  across {{len .Categories}} categories. Rankings use the Glicko-2 rating system.
]

#v(0.2in)
#table(
  columns: (1fr, auto, auto),
  align: (left, center, center),
  stroke: 0.5pt + luma(200),
  inset: 6pt,
  [*Category*], [*Comparisons*], [*Top Ring Score*],
  {{range .Categories}}
  [{{.Label}}], [{{.Comparisons}}], [{{if .Rings}}{{printf "%.0f" (index .Rings 0).Score}}{{else}}-{{end}}],
  {{end}}
)

#v(0.3in)
#align(center)[
  #text(size: 8pt, fill: gray)[
    Generated by RingRank \
    #link("http://localhost:8089")[localhost:8089]
  ]
]
