// RingRank Report - Generated {{.GeneratedAt}}
#set document(title: "Ring Preferences Report", author: "RingRank")

// Theme colors
{{if .DarkMode}}
#let bg-color = rgb("#1F2023")
#let card-bg = rgb("#27272a")
#let text-color = rgb("#f5f5f7")
#let text-dim = rgb("#a1a1aa")
#let accent = rgb("#E6AEB6")
#let border-color = rgb("#3a3a3c")
{{else}}
#let bg-color = rgb("#ffffff")
#let card-bg = rgb("#fafafa")
#let text-color = rgb("#1a1a1a")
#let text-dim = rgb("#71717a")
#let accent = rgb("#c4868f")
#let border-color = rgb("#e4e4e7")
{{end}}

#set page(
  paper: "us-letter",
  margin: (x: 0.5in, top: 1in, bottom: 0.5in),
  fill: bg-color,
  header: context {
    if counter(page).get().first() > 1 [
      #v(24pt)
      #grid(
        columns: (1fr, auto),
        align: (left + horizon, right + horizon),
        text(size: 14pt, font: "Playfair Display")[#text(fill: text-color)[RING]#text(fill: accent)[RANK]],
        text(size: 8pt, fill: text-dim)[#counter(page).display()],
      )
      #v(4pt)
      #line(length: 100%, stroke: 0.25pt + border-color)
    ]
  },
)

#set text(font: "Inter", size: 9pt, fill: text-color)

// ============ TITLE PAGE ============
#v(2fr)
#align(center)[
  #text(size: 48pt, font: "Playfair Display")[
    #text(fill: text-color)[RING]#text(fill: accent)[RANK]
  ]
  #v(8pt)
  #text(size: 12pt, fill: text-dim, weight: "light")[Your Personal Jewelry Preferences]
  #v(32pt)
  #line(length: 3in, stroke: 0.5pt + accent)
  #v(32pt)
  #text(size: 10pt, fill: text-dim)[{{.GeneratedAt}}]
  #v(16pt)
  #grid(
    columns: (auto, auto),
    gutter: 32pt,
    [#text(size: 24pt, fill: text-color, weight: "medium")[{{.TotalComparisons}}] #text(size: 10pt, fill: text-dim)[comparisons]],
    [#text(size: 24pt, fill: text-color, weight: "medium")[{{.TotalRings}}] #text(size: 10pt, fill: text-dim)[rings]],
  )
  {{if .ShowTopOnly}}
  #v(16pt)
  #text(size: 10pt, fill: accent)[Top {{.TopCount}} per category]
  {{end}}
]
#v(3fr)

// ============ HELPERS ============

// Score bar - elegant thin line
#let score-bar(score) = {
  let normalized = calc.min(100, calc.max(0, (score - 600) / 8))
  box(
    width: 50pt,
    height: 3pt,
    radius: 1.5pt,
    fill: border-color,
    box(
      width: normalized * 0.5pt,
      height: 3pt,
      radius: 1.5pt,
      fill: accent,
    )
  )
}

// Grid entry - cleaner design matching website
#let grid-entry(rank, image-path, filename, score, file-link) = {
  grid(
    columns: (24pt, 64pt, 1fr),
    align: (right + horizon, center + horizon, left + horizon),
    gutter: 8pt,
    text(size: 24pt, fill: accent, font: "Playfair Display")[#rank.],
    box(
      width: 64pt,
      height: 64pt,
      radius: 6pt,
      clip: true,
      fill: white,
      stroke: 0.5pt + border-color,
    )[
      #align(center + horizon)[
        #if image-path != "" {
          link(file-link)[#image(image-path, width: 58pt, height: 58pt, fit: "contain")]
        } else {
          box(width: 58pt, height: 58pt, fill: luma(245))
        }
      ]
    ],
    stack(
      dir: ttb,
      spacing: 4pt,
      text(size: 7pt, fill: text-dim)[#link(file-link)[#filename]],
      stack(
        dir: ltr,
        spacing: 8pt,
        text(size: 14pt, weight: "medium", fill: text-color)[#calc.round(score)],
        align(horizon, score-bar(score)),
      ),
    ),
  )
}

// Hero entry for #1
#let hero-entry(image-path, filename, score, file-link, comparisons) = {
  grid(
    columns: (48pt, 100pt, 1fr),
    align: (right + top, center + top, left + top),
    gutter: 16pt,
    text(size: 64pt, fill: accent, font: "Playfair Display")[1],
    stack(
      dir: ttb,
      spacing: 4pt,
      box(
        width: 100pt,
        height: 100pt,
        radius: 8pt,
        clip: true,
        fill: white,
        stroke: 0.5pt + border-color,
      )[
        #align(center + horizon)[
          #if image-path != "" {
            link(file-link)[#image(image-path, width: 92pt, height: 92pt, fit: "contain")]
          } else {
            box(width: 92pt, height: 92pt, fill: luma(245))
          }
        ]
      ],
      text(size: 7pt, fill: text-dim)[#filename],
    ),
    stack(
      dir: ttb,
      spacing: 12pt,
      stack(
        dir: ttb,
        spacing: 2pt,
        text(size: 28pt, weight: "bold", fill: text-color)[#calc.round(score)],
        stack(
          dir: ltr,
          spacing: 8pt,
          score-bar(score),
          text(size: 8pt, fill: text-dim)[score],
        ),
      ),
      text(size: 9pt, fill: text-dim, weight: "light")[
        Based on #text(fill: text-color, weight: "medium")[#comparisons] comparisons, this reflects your refined taste.
      ],
    ),
  )
}

// Summary card for cross-category
#let summary-card(avg-rank, image-path, filename, file-link, category-ranks, total-score) = {
  box(
    width: 100%,
    inset: 12pt,
    radius: 8pt,
    fill: card-bg,
    stroke: 0.5pt + border-color,
  )[
    #grid(
      columns: (auto, 72pt, 1fr),
      align: (center + horizon, center + horizon, left + top),
      gutter: 12pt,
      // Avg rank
      stack(
        dir: ttb,
        spacing: 2pt,
        text(size: 20pt, fill: accent, weight: "bold", font: "Playfair Display")[#avg-rank],
        text(size: 6pt, fill: text-dim, tracking: 0.05em)[AVG RANK],
      ),
      // Image
      box(
        width: 72pt,
        height: 72pt,
        radius: 6pt,
        clip: true,
        fill: white,
        stroke: 0.5pt + border-color,
      )[
        #align(center + horizon)[
          #link(file-link)[#image(image-path, width: 66pt, height: 66pt, fit: "contain")]
        ]
      ],
      // Rankings
      stack(
        dir: ttb,
        spacing: 6pt,
        text(size: 7pt, fill: text-dim)[#filename],
        grid(
          columns: (1fr,) * calc.min(category-ranks.len(), 5),
          gutter: 4pt,
          ..category-ranks.map(r => box(
            inset: (x: 4pt, y: 2pt),
            radius: 3pt,
            fill: bg-color,
          )[#align(center)[#text(size: 8pt, fill: text-color)[#r]]])
        ),
        align(right)[
          #text(size: 8pt, fill: text-dim)[Total: ]
          #text(size: 10pt, fill: text-color, weight: "medium")[#total-score]
        ],
      ),
    )
  ]
}

// ============ CATEGORY PAGES ============

{{range $cat := .Categories}}
#pagebreak(weak: true)

#text(size: 24pt, fill: text-color, font: "Playfair Display")[{{$cat.Label}}]
#h(1fr)
#text(size: 9pt, fill: text-dim)[{{$cat.Comparisons}} comparisons]
#v(16pt)

{{if $cat.Rings}}
{{with index $cat.Rings 0}}
#hero-entry("{{.ImagePath}}", "{{.Filename}}", {{printf "%.1f" .Score}}, "file://{{.FileLink}}", {{$cat.Comparisons}})
{{end}}

#v(20pt)

{{$rings := $cat.Rings}}
{{$len := len $rings}}
{{if gt $len 1}}
#grid(
  columns: (1fr, 1fr),
  column-gutter: 16pt,
  row-gutter: 12pt,
  {{range $cat.Rings}}
  {{if gt .Rank 1}}
  grid-entry({{.Rank}}, "{{.ImagePath}}", "{{.Filename}}", {{printf "%.1f" .Score}}, "file://{{.FileLink}}"),
  {{end}}
  {{end}}
)
{{end}}
{{else}}
#align(center)[
  #text(fill: text-dim, size: 10pt, style: "italic")[No comparisons yet in this category]
]
{{end}}

{{end}}

// ============ CROSS-CATEGORY SUMMARY ============

{{if .ShowCrossCategorySummary}}
#pagebreak(weak: true)

#text(size: 24pt, fill: text-color, font: "Playfair Display")[Cross-Category Performance]
#v(8pt)
#text(size: 9pt, fill: text-dim)[Overall rankings across {{len .Categories}} categories]
#v(16pt)

// Category labels header
#grid(
  columns: (80pt, 72pt, 1fr),
  gutter: 12pt,
  [],
  [],
  grid(
    columns: (1fr,) * {{len .Categories}},
    gutter: 4pt,
    {{range .Categories}}
    align(center)[#text(size: 7pt, fill: text-dim, weight: "medium")[{{.Label}}]],
    {{end}}
  ),
)
#v(8pt)

// Ring cards
#stack(
  dir: ttb,
  spacing: 8pt,
  {{range .RingSummaries}}
  box(
    width: 100%,
    inset: 12pt,
    radius: 8pt,
    fill: card-bg,
    stroke: 0.5pt + border-color,
  )[
    #grid(
      columns: (56pt, 72pt, 1fr, 56pt),
      align: (center + horizon, center + horizon, center + horizon, center + horizon),
      gutter: 12pt,
      // Avg rank
      stack(
        dir: ttb,
        spacing: 2pt,
        text(size: 18pt, fill: accent, weight: "bold", font: "Playfair Display")[{{.AvgRank}}],
        text(size: 6pt, fill: text-dim, tracking: 0.05em)[AVG],
      ),
      // Image
      box(
        width: 56pt,
        height: 56pt,
        radius: 6pt,
        clip: true,
        fill: white,
        stroke: 0.5pt + border-color,
      )[
        #align(center + horizon)[
          #link("file://{{.FileLink}}")[#image("{{.ImagePath}}", width: 50pt, height: 50pt, fit: "contain")]
        ]
      ],
      // Category ranks
      grid(
        columns: (1fr,) * {{len $.Categories}},
        gutter: 4pt,
        {{range .CategoryRanks}}
        align(center)[#text(size: 11pt, fill: text-color)[{{.}}]],
        {{end}}
      ),
      // Total
      stack(
        dir: ttb,
        spacing: 2pt,
        text(size: 12pt, fill: text-color, weight: "medium")[{{.TotalScore}}],
        text(size: 6pt, fill: text-dim, tracking: 0.05em)[TOTAL],
      ),
    )
  ],
  {{end}}
)

{{end}}

// ============ SUMMARY PAGE ============

#pagebreak(weak: true)

#text(size: 24pt, fill: text-color, font: "Playfair Display")[Summary]
#v(16pt)

#grid(
  columns: (1fr, 1fr),
  gutter: 24pt,
  // Left: description
  box(
    inset: 16pt,
    radius: 8pt,
    fill: card-bg,
    stroke: 0.5pt + border-color,
  )[
    #text(size: 10pt, fill: text-dim, weight: "light")[
      This report was generated from #text(fill: text-color, weight: "medium")[{{.TotalComparisons}} pairwise comparisons]
      across #text(fill: text-color, weight: "medium")[{{len .Categories}} categories].

      #v(8pt)

      Rankings are calculated using the #text(fill: accent)[Glicko-2 rating system], which provides accurate preference rankings even with limited comparison data.
    ]
  ],
  // Right: category stats
  box(
    inset: 16pt,
    radius: 8pt,
    fill: card-bg,
    stroke: 0.5pt + border-color,
  )[
    #stack(
      dir: ttb,
      spacing: 8pt,
      {{range .Categories}}
      grid(
        columns: (1fr, auto, auto),
        gutter: 8pt,
        align: (left + horizon, center + horizon, right + horizon),
        text(size: 9pt, fill: text-color)[{{.Label}}],
        text(size: 8pt, fill: text-dim)[{{.Comparisons}}],
        text(size: 10pt, fill: accent, weight: "bold")[{{if .Rings}}{{printf "%.0f" (index .Rings 0).Score}}{{else}}â€”{{end}}],
      ),
      {{end}}
    )
  ],
)

#v(1fr)

#align(center)[
  #line(length: 2in, stroke: 0.5pt + gradient.linear(border-color, accent, border-color))
  #v(16pt)
  #text(size: 18pt, font: "Playfair Display")[
    #text(fill: text-color)[RING]#text(fill: accent)[RANK]
  ]
  #v(4pt)
  #text(size: 8pt, fill: text-dim)[Discover your jewelry preferences]
]

#v(0.5fr)
