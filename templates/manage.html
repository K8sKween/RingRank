{{template "header" .}}

<div class="w-full max-w-6xl mx-auto p-8 lg:p-12">
    <h1 class="text-4xl md:text-5xl font-serif text-center text-white mb-4">
        Manage <span class="accent-text">Images</span>
    </h1>
    <p class="text-rr-text-dim text-center mb-12">{{.ImageCount}} images loaded</p>

    <!-- Upload Section -->
    <div class="mb-16">
        <div class="border-2 border-dashed border-white/20 rounded-xl p-16 text-center cursor-pointer hover:border-rr-pink/50 transition-colors" id="drop-zone">
            <div class="w-16 h-16 mx-auto mb-6 accent-text">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full">
                    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"></path>
                    <path d="M4 17h16"></path>
                    <polyline points="16 7 12 3 8 7"></polyline>
                    <line x1="12" y1="3" x2="12" y2="14"></line>
                </svg>
            </div>
            <p class="text-white text-lg font-light mb-2">Drag & drop images here</p>
            <p class="text-rr-text-dim text-sm">or click to browse</p>
            <input type="file" id="file-input" multiple accept="image/*" class="hidden">
        </div>

        <div class="flex justify-center gap-4 mt-6">
            <button class="accent-bg text-rr-dark hover:opacity-90 font-medium px-6 py-2 rounded-lg transition-opacity" onclick="document.getElementById('file-input').click()">
                Select Files
            </button>
            <button class="border border-white/20 text-white hover:border-rr-pink hover:text-rr-pink font-medium px-6 py-2 rounded-lg transition-colors" onclick="document.getElementById('folder-input').click()">
                Select Folder
            </button>
            <input type="file" id="folder-input" webkitdirectory multiple accept="image/*" class="hidden">
        </div>

        <div id="upload-status" class="text-center mt-4 min-h-[24px]"></div>
    </div>

    <!-- Categories Section -->
    <div class="mb-16">
        <h2 class="text-2xl font-serif text-white mb-6 pb-4 border-b border-white/10">
            Categories <span class="text-rr-text-dim font-sans text-base">({{.CategoryCount}})</span>
        </h2>

        <div class="space-y-3 mb-8" id="category-list">
            {{range .Categories}}
            <div class="flex justify-between items-center p-5 bg-[#27272a] rounded-xl border border-white/5 hover:border-white/10 transition-colors" data-id="{{.ID}}">
                <div>
                    <strong class="text-white font-serif text-lg">{{.Label}}</strong>
                    <span class="text-rr-text-dim text-xs ml-2 font-mono">{{.ID}}</span>
                    <p class="text-rr-text-dim text-sm italic mt-1">{{.Prompt}}</p>
                </div>
                <div class="flex gap-2">
                    <button class="border border-white/20 text-rr-text-dim hover:border-rr-pink hover:text-rr-pink text-xs font-medium uppercase tracking-wide px-3 py-1.5 rounded-lg transition-colors" onclick="editCategory('{{.ID}}', '{{.Label}}', '{{.Prompt}}')">Edit</button>
                    <button class="border border-white/20 text-rr-text-dim hover:border-red-400 hover:text-red-400 text-xs font-medium uppercase tracking-wide px-3 py-1.5 rounded-lg transition-colors" onclick="confirmDeleteCategory('{{.ID}}', '{{.Label}}')">Delete</button>
                </div>
            </div>
            {{end}}
        </div>

        <div class="bg-[#27272a] rounded-xl p-6 border border-white/5">
            <h3 class="text-white font-serif text-lg mb-4">Add New Category</h3>
            <div class="space-y-3">
                <input type="text" id="new-cat-label" placeholder="Label (e.g., Brilliance)" class="w-full bg-rr-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-rr-text-dim focus:border-rr-pink focus:outline-none transition-colors">
                <input type="text" id="new-cat-prompt" placeholder="Prompt (e.g., Which has better brilliance?)" class="w-full bg-rr-dark border border-white/10 rounded-lg px-4 py-3 text-white placeholder-rr-text-dim focus:border-rr-pink focus:outline-none transition-colors">
                <button class="accent-bg text-rr-dark hover:opacity-90 font-medium px-6 py-2 rounded-lg transition-opacity" onclick="addCategory()">Add Category</button>
            </div>
        </div>
    </div>

    <!-- Images Section -->
    <div>
        <h2 class="text-2xl font-serif text-white mb-6 pb-4 border-b border-white/10">
            Current Images
        </h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="image-grid">
            {{range .Images}}
            <div class="bg-[#27272a] rounded-xl overflow-hidden border border-white/5 group hover:border-white/10 transition-colors" data-filename="{{.Filename}}">
                <div class="relative aspect-square bg-white">
                    <img src="/rings/{{.Filename}}" alt="{{.Filename}}" class="w-full h-full object-contain p-2">
                    <button class="absolute top-2 right-2 w-7 h-7 bg-rr-dark/80 border border-white/20 rounded-lg text-white text-sm font-bold opacity-0 group-hover:opacity-100 hover:bg-red-600 hover:border-red-600 transition-all" onclick="confirmDelete('{{.Filename}}')" title="Delete">Ã—</button>
                </div>
                <div class="p-3">
                    <p class="text-xs text-rr-text-dim truncate">{{.Filename}}</p>
                    {{if .HasRankings}}<p class="text-xs accent-text mt-1">Has rankings</p>{{end}}
                </div>
            </div>
            {{else}}
            <p class="col-span-full text-center text-rr-text-dim py-16 font-light">No images yet. Upload some to get started!</p>
            {{end}}
        </div>

        {{if .Images}}
        <!-- Remove All Button -->
        <div class="mt-8 pt-8 border-t border-white/10 flex justify-end">
            <button onclick="confirmRemoveAll()" class="border border-red-500/50 text-red-400 hover:bg-red-500/10 hover:border-red-500 text-sm font-medium px-4 py-2 rounded-lg transition-colors">
                Remove All Images
            </button>
        </div>
        {{end}}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center backdrop-blur-sm" id="delete-modal">
    <div class="bg-rr-dark border border-white/10 rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
        <h3 class="text-xl font-serif text-white mb-4">Delete Image?</h3>
        <p class="text-rr-text-light mb-2" id="modal-message"></p>
        <p class="text-rr-text-dim text-sm mb-6">This will also remove all rankings for this image.</p>
        <label class="flex items-center gap-2 text-sm text-rr-text-dim mb-6 cursor-pointer">
            <input type="checkbox" id="dont-ask-checkbox" class="w-4 h-4 rounded accent-rr-pink">
            Don't ask again this session
        </label>
        <div class="flex justify-end gap-3">
            <button class="border border-white/20 text-rr-text-dim hover:text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="closeModal()">Cancel</button>
            <button class="bg-red-600 text-white hover:bg-red-700 text-sm font-medium px-4 py-2 rounded-lg transition-colors" id="confirm-delete-btn">Delete</button>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center backdrop-blur-sm" id="edit-modal">
    <div class="bg-rr-dark border border-white/10 rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
        <h3 class="text-xl font-serif text-white mb-4">Edit Category</h3>
        <input type="hidden" id="edit-cat-id">
        <div class="space-y-3 mb-6">
            <input type="text" id="edit-cat-label" placeholder="Label" class="w-full bg-[#27272a] border border-white/10 rounded-lg px-4 py-3 text-white placeholder-rr-text-dim focus:border-rr-pink focus:outline-none transition-colors">
            <input type="text" id="edit-cat-prompt" placeholder="Prompt" class="w-full bg-[#27272a] border border-white/10 rounded-lg px-4 py-3 text-white placeholder-rr-text-dim focus:border-rr-pink focus:outline-none transition-colors">
        </div>
        <div class="flex justify-end gap-3">
            <button class="border border-white/20 text-rr-text-dim hover:text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="closeEditModal()">Cancel</button>
            <button class="accent-bg text-rr-dark hover:opacity-90 text-sm font-medium px-4 py-2 rounded-lg transition-opacity" onclick="saveCategory()">Save</button>
        </div>
    </div>
</div>

<!-- Delete Category Modal -->
<div class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center backdrop-blur-sm" id="cat-delete-modal">
    <div class="bg-rr-dark border border-white/10 rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
        <h3 class="text-xl font-serif text-white mb-4">Delete Category?</h3>
        <p class="text-rr-text-light mb-2" id="cat-modal-message"></p>
        <p class="text-rr-text-dim text-sm mb-6">This will remove all rankings for this category.</p>
        <div class="flex justify-end gap-3">
            <button class="border border-white/20 text-rr-text-dim hover:text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="closeCatDeleteModal()">Cancel</button>
            <button class="bg-red-600 text-white hover:bg-red-700 text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="deleteCategory()">Delete</button>
        </div>
    </div>
</div>

<!-- Remove All Images Modal -->
<div class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center backdrop-blur-sm" id="remove-all-modal">
    <div class="bg-rr-dark border border-white/10 rounded-xl p-8 max-w-md w-[90%] shadow-2xl">
        <h3 class="text-xl font-serif text-white mb-4">Remove All Images?</h3>
        <p class="text-rr-text-light mb-2">This will delete all {{.ImageCount}} images.</p>
        <p class="text-rr-text-dim text-sm mb-6">All rankings and comparison data will be permanently lost. This cannot be undone.</p>
        <div class="flex justify-end gap-3">
            <button class="border border-white/20 text-rr-text-dim hover:text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="closeRemoveAllModal()">Cancel</button>
            <button class="bg-red-600 text-white hover:bg-red-700 text-sm font-medium px-4 py-2 rounded-lg transition-colors" onclick="removeAllImages()">Remove All</button>
        </div>
    </div>
</div>

<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const folderInput = document.getElementById('folder-input');
const status = document.getElementById('upload-status');
const modal = document.getElementById('delete-modal');
const modalMessage = document.getElementById('modal-message');
const dontAskCheckbox = document.getElementById('dont-ask-checkbox');
const confirmBtn = document.getElementById('confirm-delete-btn');

let pendingFilename = null;
let skipConfirmation = false;

// Drag and drop
dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-rr-pink/50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-rr-pink/50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-rr-pink/50');
    handleFiles(e.dataTransfer.files);
});

// File inputs
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

async function handleFiles(files) {
    if (!files.length) return;

    const formData = new FormData();
    let count = 0;

    for (const file of files) {
        if (file.type.startsWith('image/')) {
            formData.append('images', file);
            count++;
        }
    }

    if (count === 0) {
        status.textContent = 'No valid images selected';
        status.className = 'text-center mt-4 min-h-[24px] text-red-400';
        return;
    }

    status.textContent = `Uploading ${count} image(s)...`;
    status.className = 'text-center mt-4 min-h-[24px] text-rr-text-dim';

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            status.textContent = `Successfully uploaded ${result.uploaded} image(s)`;
            status.className = 'text-center mt-4 min-h-[24px] accent-text';
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error('Upload failed');
        }
    } catch (err) {
        status.textContent = 'Upload failed: ' + err.message;
        status.className = 'text-center mt-4 min-h-[24px] text-red-400';
    }
}

function confirmDelete(filename) {
    if (skipConfirmation) {
        deleteImage(filename);
        return;
    }

    pendingFilename = filename;
    modalMessage.textContent = `Delete "${filename}"?`;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    pendingFilename = null;
}

confirmBtn.addEventListener('click', () => {
    if (dontAskCheckbox.checked) {
        skipConfirmation = true;
    }
    if (pendingFilename) {
        deleteImage(pendingFilename);
    }
    closeModal();
});

modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (!modal.classList.contains('hidden')) closeModal();
        if (!document.getElementById('edit-modal').classList.contains('hidden')) closeEditModal();
        if (!document.getElementById('cat-delete-modal').classList.contains('hidden')) closeCatDeleteModal();
    }
});

async function deleteImage(filename) {
    try {
        const response = await fetch('/delete-image', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `filename=${encodeURIComponent(filename)}`
        });

        const result = await response.json();

        if (result.success) {
            const card = document.querySelector(`[data-filename="${filename}"]`);
            if (card) card.remove();
        }
    } catch (err) {
        alert('Failed to delete: ' + err.message);
    }
}

// Category Management
function generateId(label) {
    return label
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '_')
        .replace(/^_+|_+$/g, '')
        .replace(/_+/g, '_')
        || 'category';
}

async function addCategory() {
    const label = document.getElementById('new-cat-label').value.trim();
    const prompt = document.getElementById('new-cat-prompt').value.trim();

    if (!label || !prompt) {
        alert('Please fill in all fields');
        return;
    }

    const id = generateId(label);

    try {
        const response = await fetch('/add-category', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `id=${encodeURIComponent(id)}&label=${encodeURIComponent(label)}&prompt=${encodeURIComponent(prompt)}`
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to add category');
        }
    } catch (err) {
        alert('Failed to add category: ' + err.message);
    }
}

let pendingCategoryId = null;
let pendingCategoryLabel = null;

function editCategory(id, label, prompt) {
    document.getElementById('edit-cat-id').value = id;
    document.getElementById('edit-cat-label').value = label;
    document.getElementById('edit-cat-prompt').value = prompt;
    document.getElementById('edit-modal').classList.remove('hidden');
    document.getElementById('edit-modal').classList.add('flex');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    document.getElementById('edit-modal').classList.remove('flex');
}

async function saveCategory() {
    const id = document.getElementById('edit-cat-id').value;
    const label = document.getElementById('edit-cat-label').value.trim();
    const prompt = document.getElementById('edit-cat-prompt').value.trim();

    if (!label || !prompt) {
        alert('Please fill in all fields');
        return;
    }

    try {
        const response = await fetch('/update-category', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `id=${encodeURIComponent(id)}&label=${encodeURIComponent(label)}&prompt=${encodeURIComponent(prompt)}`
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to update category');
        }
    } catch (err) {
        alert('Failed to update category: ' + err.message);
    }
}

function confirmDeleteCategory(id, label) {
    pendingCategoryId = id;
    pendingCategoryLabel = label;
    document.getElementById('cat-modal-message').textContent = `Delete category "${label}"?`;
    document.getElementById('cat-delete-modal').classList.remove('hidden');
    document.getElementById('cat-delete-modal').classList.add('flex');
}

function closeCatDeleteModal() {
    document.getElementById('cat-delete-modal').classList.add('hidden');
    document.getElementById('cat-delete-modal').classList.remove('flex');
    pendingCategoryId = null;
    pendingCategoryLabel = null;
}

async function deleteCategory() {
    if (!pendingCategoryId) return;

    try {
        const response = await fetch('/delete-category', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `id=${encodeURIComponent(pendingCategoryId)}`
        });

        const result = await response.json();

        if (result.success) {
            const card = document.querySelector(`.category-card[data-id="${pendingCategoryId}"]`);
            if (card) card.remove();
            closeCatDeleteModal();
            location.reload();
        } else {
            alert(result.error || 'Failed to delete category');
        }
    } catch (err) {
        alert('Failed to delete category: ' + err.message);
    }
}

document.getElementById('edit-modal').addEventListener('click', (e) => {
    if (e.target.id === 'edit-modal') closeEditModal();
});
document.getElementById('cat-delete-modal').addEventListener('click', (e) => {
    if (e.target.id === 'cat-delete-modal') closeCatDeleteModal();
});

// Remove All Images
const removeAllModal = document.getElementById('remove-all-modal');

function confirmRemoveAll() {
    removeAllModal.classList.remove('hidden');
    removeAllModal.classList.add('flex');
}

function closeRemoveAllModal() {
    removeAllModal.classList.add('hidden');
    removeAllModal.classList.remove('flex');
}

removeAllModal.addEventListener('click', (e) => {
    if (e.target === removeAllModal) closeRemoveAllModal();
});

async function removeAllImages() {
    try {
        const response = await fetch('/delete-all-images', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            closeRemoveAllModal();
            location.reload();
        } else {
            alert(result.error || 'Failed to remove all images');
        }
    } catch (err) {
        alert('Failed to remove all images: ' + err.message);
    }
}
</script>

{{template "footer" .}}
